// Script (C) 2012 by Mark Rosenfelder.
// You can modify the code for non-commercial use; 
// attribution would be nice.
// If you want to make money off it, please contact me.

// Modified by Jason Tamez 2017-2019.
// Code available here: https://github.com/jasontamez/wordgen

// Minified by https://javascript-minifier.com/ (with extra linebreaks)


var categories,midWordSyls,wordInitSyls,wordFinalSyls,singleWordSyls,rew,previousCat=!1,previousMidWordSyls=!1,previousWordInitSyls=!1,previousWordFinalSyls=!1,previousSingleWordSyls=!1,previousRew=!1,rewSep=!1,CustomInfo=!1,Customizable=!1,getter=new XMLHttpRequest,predefFilename="/predefs.txt",predefs=new Map,SPACE=String.fromCharCode(160);function $i(e,t=document){return t.getElementById(e)}function $q(e,t=document){return t.querySelector(e)}function $a(e,t=document){return t.querySelectorAll(e)}function $e(e,t=!1,o=!1){var r=document.createElement(e);return!1!==t&&(r.textContent=t),!1!==o&&Object.entries(o).forEach(e=>r.setAttribute(e[0],e[1])),r}function $t(e){return document.createTextNode(e)}function $f(){return document.createDocumentFragment()}function parseSyllables(e){var t=[];return e.split(/\r?\n/).forEach(function(e){var o=e.trim();""!==o&&t.push(o)}),t}function handleCategoriesInRewriteRule(e){for(var t,o,r,n=e.split("%%"),i=[];n.length;){for(o=(t=n.shift().split("!%")).shift();t.length;){let e;r=t.shift(),e=categories.get(r.charAt(0)),void 0!==test&&(o+="[^"+e+"]"),o+=r.substring(1)}for(t=o.split("%"),o=t.shift();t.length;){let e;r=t.shift(),void 0!==(e=categories.get(r.charAt(0)))&&(o+="["+e+"]"),o+=r.substring(1)}i.push(o)}return i.join("%")}function applyRewriteRules(e){return rew.forEach(function(t,o){e=e.replace(o,t)}),e}function getRandomPercentage(){return Math.floor(101*Math.random())}function powerLaw(e,t){var o;for(o=0;;o=(o+1)%e)if(getRandomPercentage()<t)return o}function peakedPowerLaw(e,t,o){return Math.random()>.5?t+powerLaw(e-t,o):t-powerLaw(t+1,o)}
function oneSyllable(e,t,o,r){var n,i,a,l=syllPatternPick(t,r);for(n=0;n<l.length;n++)void 0===(i=categories.get(l.charAt(n)))?e+=i:(a=0===o?Math.random()*i.length:powerLaw(i.length,o),e+=i.charAt(a));return e}function syllPatternPick(e,t){var o,r;switch(e){case-1:r=wordInitSyls;break;case 0:r=midWordSyls;break;case 1:r=wordFinalSyls;break;case 2:r=singleWordSyls}return r[powerLaw(o=r.length,calcDropoff(o,t))]}function getOneWord(e,t,o,r,n,i){var a,l,s=1,u="";if(Math.random()>t&&(s+=1+powerLaw(4,50)),1===s)u=oneSyllable("",o?-1:2,n,i);else for(a=1;a<=s;a++)o||1===a?l=-1:a>1&&(l=a<s?0:1),u=oneSyllable(u,l,n,i),r&&a<s&&(u+="Â·");return u=applyRewriteRules(u),e&&(u=u.charAt(0).toUpperCase()+u.substring(1)),u}function createText(e,t,o,r,n){var i,a,l,s="",u=getAdvancedNumber($i("sentences"),30,500);for(i=0;i<u;i++)for(l=peakedPowerLaw(15,5,50),a=0;a<=l;a++)s+=getOneWord(0===a,e,t,o,r,n),a===l&&(s+=".....?!".charAt(Math.floor(7*Math.random()))),s+=" ";return $t(s)}function createLex(e,t,o,r,n,i){var a,l=$e("div"),s=getAdvancedNumber($i("lexiconLength"),150,1e3),u=[];for(l.classList.add("lexicon"),l.style.gridTemplateColumns="repeat(auto-fit, minmax("+getAdvancedNumber($i("wordLengthInEms"),10,1e3).toString()+"em, 1fr) )",a=0;a<s;a++)u.push(getOneWord(e,t,o,r,n,i));return u.sort(),u.forEach(function(e){l.appendChild($e("div",e))}),l}function createLongLex(e,t,o,r,n){var i,a=$f(),l=getAdvancedNumber($i("largeLexiconLength"),750,5e3);for(i=0;i<l;i++)a.append(getOneWord(!1,e,t,o,r,n),$e("br"));return a}function getAdvancedNumber(e,t,o){var r=parseInt(e.value);return isNaN(r)||r<1?t:r>o?o:r}
function getEverySyllable(){var e,t=new Set,o=$f();return new Set(midWordSyls.concat(wordInitSyls,wordFinalSyls,singleWordSyls)).forEach(function(e){recurseCategories(t,"",e.split(""))}),(e=[...t]).sort(),o.appendChild($t(e.shift())),e.forEach(e=>o.append($e("br"),e)),o}function recurseCategories(e,t,o){var r,n=o.slice(0);void 0===(r=categories.get(n.shift()))?(t+=r,n.length?recurseCategories(e,t,n):e.add(applyRewriteRules(t))):n.length>0?r.split("").forEach(function(o){recurseCategories(e,t+o,n)}):r.split("").forEach(function(o){e.add(applyRewriteRules(t+o))})}function escapeHTML(e){return $e("p",e).innerHTML}
function generate(){var e,t,o,r,n,i,a,l,s,u,d=[];if(e=$q("input[type=radio][name=outType]:checked").value,i=$i("showSyls").checked,a=$i("slowSylDrop").checked,l=$i("oneType").checked,s=Number($q("input[type=radio][name=monoRate]:checked").value),u=Number($q("input[type=radio][name=dropoff]:checked").value),(s=Math.min(Math.max(s,0),1))!=s&&(s=1),(u=Math.min(Math.max(u,0),45))!=u&&(u=45),(t=$i("categories").value)!==previousCat){let e=parseCategories(t);e.flag&&e.cats.size>0?(previousCat=t,categories=e.cats):d.push(...e.msgs)}if((t=$i("midWord").value)!==previousMidWordSyls&&(midWordSyls=parseSyllables(t),previousMidWordSyls=t),(t=$i("wordInitial").value)!==previousWordInitSyls&&(wordInitSyls=parseSyllables(t),previousWordInitSyls=t),(t=$i("wordFinal").value)!==previousWordFinalSyls&&(wordFinalSyls=parseSyllables(t),previousWordFinalSyls=t),(t=$i("singleWord").value)!==previousSingleWordSyls&&(singleWordSyls=parseSyllables(t),previousSingleWordSyls=t),t=$i("rewrite").value,o=$i("rewSep").value,previousRew!==t||o!==rewSep){let e;rewSep=o,(e=parseRewriteRules(t)).flag?(previousRew=t,rew=e.rules):d.push(...e.msgs)}if(categories.size<=0&&((r=$f()).append($e("strong","Missing:"),SPACE+"You must have categories to generate text."),d.push(r)),l&&wordInitSyls.length<=0?((r=$f()).append($e("strong","Missing:"),SPACE+"You must have syllable types to generate text."),d.push(r)):!l&&(midWordSyls.length<=0||wordInitSyls.length<=0||wordFinalSyls.length<=0||singleWordSyls.length<=0)&&((r=$f()).append($e("strong","Missing:"),SPACE+"You must have"+SPACE,$e("em","all"),SPACE+"syllable types to generate text."),d.push(r)),d.length>0)(n=$f()).appendChild(d.shift()),d.forEach(function(e){n.append($e("br"),$e("br"),e)});else switch(e){case"text":n=createText(s,l,i,u,a);break;case"dict":n=createLex(!1,s,l,i,u,a);break;case"dictC":n=createLex(!0,s,l,i,u,a);break;case"longdict":n=createLongLex(s,l,i,u,a);break;case"genall":n=getEverySyllable()}erase(),$i("outputText").appendChild(n)}
function parseCategories(e){var t=e.split(/\r?\n/),o=new Map,r=[];return{flag:t.every(function(e){var t=e.trim();const n=t.length;if(0===n);else{if(n<3||1!==t.indexOf("=")||-1!==t.indexOf("=",2)){let e=$f();return e.append($e("strong","Error:"),SPACE+t,$e("br"),"Categories must be of the form V=aeiou",$e("br"),"That is, a single letter, an equal sign, then a list of possible expansions."),r.push(e),!1}{let e=t.charAt(0);if(void 0!==o.get(e)){let e=$f();return e.append($e("strong","Error:"),SPACE+"You have defined category "+t+" more than once."),r.push(e),!1}o.set(e,t.substring(2))}}return!0}),cats:o,msgs:r}}function parseRewriteRules(e){var t=e.split(/\r?\n/),o=new Map,r=[];return{flag:t.every(function(e){var t=e.indexOf(rewSep);if(""===e.trim());else{if(t<1||t!==e.lastIndexOf(rewSep)){let t=$f();return t.append($e("strong","Error:"),SPACE+e,$e("br"),"Rewrite rules must be in the form x"+rewSep+"y",$e("br"),"That is, a rule (x), followed by "+("||"===rewSep?"two vertical bars":'the exact text "'+rewSep+'"')+", followed by a replacement expression (y, which may be blank)."),r.push(t),!1}{let r=e.substring(t+2),n=new RegExp(handleCategoriesInRewriteRule(e.substring(0,t)),"g");o.set(n,r)}}return!0}),rules:o,msgs:r}}function calcDropoff(e,t){if(1===e)return 101;if(t)switch(e){case 2:return 50;case 3:return 40;case 4:case 5:case 6:case 7:case 8:case 9:return 46-4*e;default:return 9}return e<9?60-5*e:12}function erase(){for(var e=$i("outputText");e.firstChild;)e.removeChild(e.firstChild)}
function clearBoxes(){$i("categories").value="",$i("wordInitial").value="",$i("midWord").value="",$i("singleWord").value="",$i("wordFinal").value="",$i("rewrite").value="",$i("monoLessFrequent").checked=!0,$i("dropoffMedium").checked=!0,$i("textOutput").checked=!0,$i("showSyls").checked=!1,$i("slowSylDrop").checked=!1}function prepImport(e){"string"!=typeof e?$a("#importBoxArea .msg").forEach(e=>e.classList.add("hidden")):$a("#importBoxArea .msg").forEach(function(t){var o=e.split("<br>");t.textContent=o.shift(),o.forEach(function(e){t.append($e("br"),e)}),t.classList.remove("hidden")}),$i("importBoxArea").classList.remove("closed"),document.body.classList.add("noOverflow")}function removeImportBox(){$i("importTextBox").value="",$i("importBoxArea").classList.add("closed"),document.body.classList.remove("noOverflow")}function doImport(e,t=!1,o=!0){var r,n=new RegExp("--CATEGORIES--\\n([\\s\\S]*)\\n--REWRITE--\\n([\\s\\S]*)\\n--MONO--\\n([\\s\\S]*)\\n--MID--\\n([\\s\\S]*)\\n--INIT--\\n([\\s\\S]*)\\n--FINAL--\\n([\\s\\S]*)\\n--FLAGS--\\n([01]) ([01]) ([^ ]+) ([^ \\n]+)(\\n--ADVANCED--\\n([0-9]+)\\n([0-9]+)\\n([0-9]+)\\n([0-9]+)\\n([^\\n]+))?");if("string"!=typeof e&&(e=$i("importTextBox").value.trim()),r=n.exec(e),t)return null!==r||(console.log("Incorrect predef format."),!1);if(null===r)return!!o&&(console.log(r),console.log(n),console.log(e),doAlert("Incorrect format.","","error"));if($i("categories").value=r[1],$i("rewrite").value=r[2],$i("singleWord").value=r[3],$i("midWord").value=r[4],$i("wordInitial").value=r[5],$i("wordFinal").value=r[6],$i("oneType").checked="0"!==r[7],$i("slowSylDrop").checked="0"!==r[8],$i(r[9]).checked=!0,$i(r[10]).checked=!0,r.length>12&&void 0!==r[11]){let e=12;for(;e<16;){let t=Number(r[e]);(!Number.isInteger(t)||t<1)&&(r[e]="1"),e++}$i("wordLengthInEms").value=r[12],$i("lexiconLength").value=r[13],$i("largeLexiconLength").value=r[14],$i("sentences").value=r[15],$i("rewSep").value=r[16]}if(syllabicChangeDetection(),!o)return!0;doAlert("Import Successful!","","success"),removeImportBox()}
function doExport(e=!0){var t;if(null===e){let e=!0;return t="--CATEGORIES--\n"+$i("categories").defaultValue+"\n--REWRITE--\n"+$i("rewrite").defaultValue+"\n--MONO--\n"+$i("singleWord").defaultValue+"\n--MID--\n"+$i("midWord").defaultValue+"\n--INIT--\n"+$i("wordInitial").defaultValue+"\n--FINAL--\n"+$i("wordFinal").defaultValue+"\n--FLAGS--\n"+($i("oneType").defaultChecked?"1":"0")+" "+($i("slowSylDrop").defaultChecked?"1":"0")+" ",$a("input[name=monoRate]").forEach(function(o){e&&o.defaultChecked&&(t+=o.getAttribute("id")+" ",e=!1)}),e=!0,$a("input[name=dropoff]").forEach(function(o){e&&o.defaultChecked&&(t+=o.getAttribute("id"),e=!1)}),t}if(t="--CATEGORIES--\n"+$i("categories").value+"\n--REWRITE--\n"+$i("rewrite").value+"\n--MONO--\n"+$i("singleWord").value+"\n--MID--\n"+$i("midWord").value+"\n--INIT--\n"+$i("wordInitial").value+"\n--FINAL--\n"+$i("wordFinal").value+"\n--FLAGS--\n"+($i("oneType").checked?"1":"0")+" "+($i("slowSylDrop").checked?"1":"0")+" "+$q("input[name=monoRate]:checked").getAttribute("id")+" "+$q("input[name=dropoff]:checked").getAttribute("id"),!e)return t;t+="\n--ADVANCED--\n"+$i("wordLengthInEms").value+"\n"+$i("lexiconLength").value+"\n"+$i("largeLexiconLength").value+"\n"+$i("sentences").value+"\n"+$i("rewSep").value,$i("importTextBox").value=t,prepImport("Copy this for your own records.<br><br>Hit 'Cancel' when you're done.")}
function saveCustom(e){var t=$i("predef");if(Customizable){if(CustomInfo&&!0!==e)return doConfirm("Warning!","You already have information saved. Do you want to overwrite it?",function(){saveCustom(!0)},function(){doAlert("Previous information saved.","Nothing overwritten.","success")},"warning","Yes","No");if(localStorage.setItem("CustomCategories",$i("categories").value),localStorage.setItem("CustomRewrite",$i("rewrite").value),localStorage.setItem("CustomSingleWord",$i("singleWord").value),localStorage.setItem("CustomMidWord",$i("midWord").value),localStorage.setItem("CustomInitial",$i("wordInitial").value),localStorage.setItem("CustomFinal",$i("wordFinal").value),localStorage.setItem("CustomOneType",$i("oneType").checked),localStorage.setItem("CustomSlowSylDrop",$i("slowSylDrop").checked),localStorage.setItem("CustomMono",$q("input[name=monoRate]:checked").getAttribute("id")),localStorage.setItem("CustomDropoff",$q("input[name=dropoff]:checked").getAttribute("id")),localStorage.setItem("CustomWordLengthInEms",$i("wordLengthInEms").value),localStorage.setItem("CustomLexiconLength",$i("lexiconLength").value),localStorage.setItem("CustomLargeLexiconLength",$i("largeLexiconLength").value),localStorage.setItem("CustomSentences",$i("sentences").value),localStorage.setItem("CustomRewSep",$i("rewSep").value),CustomInfo=!0,null==$q('option[value="pd-1"]',t)){let e=document.createElement("option");e.value="pd-1",e.textContent="Custom",t.prepend(e)}t.value="pd-1",predefs.set("pd-1",doExport(!1)),doAlert("Saved to browser.","","success")}else doAlert("","Your browser does not support Local Storage and cannot save your information.","error")}
function clearCustom(e){if(Customizable)if(CustomInfo){if(CustomInfo&&!0!==e)return doConfirm("Warning!","Are you sure you want to delete your saved settings?",function(){clearCustom(!0)},function(){doAlert("Settings kept.","","success")},"warning","Yes","No");["CustomCategories","CustomRewrite","CustomSingleWord","CustomMidWord","CustomInitial","CustomFinal","CustomOneType","CustomSlowSylDrop","CustomMono","CustomDropoff","CustomWordLengthInEms","CustomLexiconLength","CustomLargeLexiconLength","CustomSentences","CustomRewSep"].forEach(function(e){window.localStorage.removeItem(e)}),CustomInfo=!1,$q('#predef option[value="-1"]').remove(),predefs.delete("pd-1"),doAlert("Cleared from browser.","","success")}else doAlert("","You don't have anything saved.","error");else doAlert("Sorry!","Your browser does not support Local Storage and cannot save your information.","error")}function showIPA(){erase(),$i("outputText").appendChild(createIPASymbolsFragment([$e("br"),$e("br")]))}function advancedOptions(){$i("advancedOpen").classList.toggle("closed")}function loadPredef(){var e=$i("predef").value;console.log("Opening predef ["+e+"]"),doImport(predefs.get(e),!1,!1),syllabicChangeDetection()}function parseResult(){var e=getter.responseText.trim().split(/\n--END--/),t=predefs.size+(void 0===predefs.get("pd-1")?0:-1);e.forEach(function(e){var o=e.trim().match(/^([^\r\n]+)\r?\n/);if(null===o)console.log("Unable to parse predef name: "+e);else{let r=o[0].trim(),n=e.slice(o[0].length).replace(/\r/g,"").trim();if(console.log("Testing predef: "+r),doImport(n,!0)){let e=$i("predef"),o=document.createElement("option"),i="pd";console.log("Saving predef: "+r),i+=(++t).toString(),predefs.set(i,n),o.textContent=r,o.value=i,e.appendChild(o)}else console.log(n.replace(/\n/g,"\\n"))}}),$i("loadPredefButton").disabled=!1,$i("predef").disabled=!1}
function syllabicChangeDetection(){$i("oneType").checked?($a("#p_multi,.multiswap").forEach(e=>e.classList.add("hidden")),$a(".singleswap").forEach(e=>e.classList.remove("hidden"))):($a("#p_multi,.multiswap").forEach(e=>e.classList.remove("hidden")),$a(".singleswap").forEach(e=>e.classList.add("hidden")))}if(getter.addEventListener("load",parseResult),getter.open("GET",predefFilename),getter.send(),$i("loadPredefButton").disabled=!0,$i("predef").disabled=!0,predefs.set("pd1",doExport(null)),"undefined"!=typeof Storage){if(Customizable=!0,null!==localStorage.getItem("CustomCategories")){CustomInfo=!0;let e=document.createElement("option"),t=[localStorage.getItem("CustomMono"),localStorage.getItem("CustomDropoff")],o=[];$i("categories").value=localStorage.getItem("CustomCategories"),$i("rewrite").value=localStorage.getItem("CustomRewrite"),$i("singleWord").value=localStorage.getItem("CustomSingleWord"),$i("midWord").value=localStorage.getItem("CustomMidWord"),$i("wordInitial").value=localStorage.getItem("CustomInitial"),$i("wordFinal").value=localStorage.getItem("CustomFinal"),"true"===localStorage.getItem("CustomOneType")?t.push("oneType"):o.push("oneType"),"true"===localStorage.getItem("CustomSlowSylDrop")?t.push("slowSylDrop"):o.push("slowSylDrop"),t.forEach(e=>$i(e).checked=!0),o.forEach(e=>$i(e).checked=!1),predefs.set("pd-1",doExport(!1)),e.value="pd-1",e.textContent="Custom",$i("predef").prepend(e),$i("predef").value="pd-1"}syllabicChangeDetection()}
function doAlert(e,t,o){"undefined"!=typeof Swal?Swal.fire({type:o,title:e,html:t,customClass:"doAlertBox",buttonsStyling:!1}):alert((e+" "+t.replace(/<br>/g,"\n").replace(/<[^>]*>/g,"")).trim())}function doConfirm(e,t,o,r,n="question",i="Ok",a="Cancel"){"undefined"!=typeof Swal?Swal.fire({title:e,html:t,type:n,showCancelButton:!0,confirmButtonText:i,cancelButtonText:a,customClass:"doAlertBox",buttonsStyling:!1}).then(e=>e.value?o.call():r.call()):confirm((e+" "+t.replace(/<br>/g,"\n").replace(/<[^>]*>/g,"")).trim())?o.call():r.call()}$i("oneType").addEventListener("change",syllabicChangeDetection),syllabicChangeDetection(),$i("advancedOpenButton").addEventListener("click",advancedOptions),$i("saveCustomButton").addEventListener("click",saveCustom),$i("clearCustomButton").addEventListener("click",clearCustom),$i("prepImportButton").addEventListener("click",prepImport),$i("generateButton").addEventListener("click",generate),$i("eraseButton").addEventListener("click",erase),$i("clearBoxesButton").addEventListener("click",clearBoxes),$i("showIPAButton").addEventListener("click",showIPA),$i("loadPredefButton").addEventListener("click",loadPredef),$i("doImportButton").addEventListener("click",doImport),$i("removeImportBoxButton").addEventListener("click",removeImportBox),$i("doExportButton").addEventListener("click",doExport);
