// Script (C) 2012 by Mark Rosenfelder.
// You can modify the code for non-commercial use; 
// attribution would be nice.
// If you want to make money off it, please contact me.

// Fixes since SCA1:
//	Degemination			M//_2       (subscript 2)	** shortening a consonant
//	Gemination				M/M2/_				** lengthening one

// Modified by Jason Tamez 2017-2019.
// Code available here: https://github.com/jasontamez/wordgen

// Minified by https://javascript-minifier.com/ (with extra linebreaks)


var cat,ncat,previousCat,change,nchange,previousChange,rew,nrew,previousRew,Customizable=!1,CustomInfo=!1,previousRun=!1,SPACE=String.fromCharCode(160);function $i(e,t=document){return t.getElementById(e)}function $q(e,t=document){return t.querySelector(e)}function $a(e,t=document){return t.querySelectorAll(e)}function $e(e,t=!1){var n=document.createElement(e);return!1!==t&&(n.textContent=t),n}
function isCombiningDiacritic(e){return 768<=e&&e<=879||6832<=e&&e<=6911||7616<=e&&e<=7679||8400<=e&&e<=8447||65056<=e&&e<=65071}function standardizePhonoRules(e,t){var n,o,r,i;i=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");try{return n=[8594,8649,8677,8680,8658,8688,8694,8611,8614,8618,8674,8702,8620,8605,8608,8692,8667,8640,8641,8669,8699],r=new RegExp("(?<=^)(?<="+i+")s*["+String.fromCharCode(8960)+String.fromCharCode(8709)+"]s*(?="+i+"|$)","g"),o=new RegExp("(?<!"+i+".*)[>"+n.map(e=>String.fromCharCode(e)).join("")+"]","g"),e.replace(r,"").replace(o,t)}catch(a){if("SyntaxError"===a.name){let a;for(r=new RegExp("(^|"+i+")(s*["+String.fromCharCode(8960)+String.fromCharCode(8709)+"]s*)("+i+"|$)","g"),o=new RegExp("("+i+".*)([>"+n.map(e=>String.fromCharCode(e)).join("")+"])","g");null!==(a=r.exec(e));){let t=a[0].length,n=r.lastIndex,o=e.slice(0,n-t),i=e.slice(n);e=o+a[1]+a[3]+i}for(;null!==(a=o.exec(e));){let n=a[0].length,r=o.lastIndex,i=e.slice(0,r-n),s=e.slice(r);e=i+a[1]+t+s}}return e}}
function changeTheWords(e,t,n){var o,r,i=new Object,a=0;return i.words=[],i.info=[],e.forEach(function(e){var o,s,l=e.trim(),u=0;if(""!==l){for(;u<nrew;)rew.index[u]>=0&&(l=l.replace(rew["inToOut"+u.toString()],rew["inToOutString"+u.toString()])),u++;for(u=0;u<nchange;){let e=u.toString();s=change["to"+e].slice(),o=l,change["from"+e].forEach(function(t){var o,a,c,h,d,g,p,f;for(t.lastIndex=0,o=t.exec(l),a=t.lastIndex,c=s.shift();null!==o;)if(g=l.length,change.eind[u]&&(""===(p=change["exceptionPre"+e])?p=0:(f=l.slice(0,a-o[o.length-1].length),p+=l.slice(a-o[0].length+o[1].length,a-o[o.length-1].length).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"$",p=f.search(RegExp(p))),p>=0&&(""===(f=change["exceptionPost"+e])?f=0:(p=l.slice(a-o[0].length+o[1].length),f="^"+l.slice(a-o[o.length-1].length,a).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+f,f=p.search(RegExp(f))),f>=0)))n&&(i.append($e("span",change["rule"+e])),(r=$e("span",String.fromCharCode(8658))).classList.add("arrow"),i.info.push(r,$e("span",l)),(r=$e("span",String.fromCharCode(8594))).classList.add("arrow"),i.info.push(r),(r=$e("span","[unchanged due to exception]")).appendChild($e("br")),i.info.push(r)),""!==o[0]||0!==a&&a!==g?(o=t.exec(l),a=t.lastIndex):o=null;else{if(o.length>3)for(h=l.slice(0,a-o.shift().length)+o.shift(),d=o.pop()+l.slice(a),l=h+l.slice(h.length-1,a-0).replace("",c)+d,f=o.length;f>0;)c=c.replace(RegExp("\\$"+f.toString(),"g"),o.pop()),f--;else h=l.slice(0,a-o[0].length)+o[1],d=o[2]+l.slice(a);l=h+c+d,""!==o[0]||0!==a&&a!==g?(o=t.exec(l),a=t.lastIndex):o=null}}),n&&o!==l&&(i.info.push($e("span",change["rule"+e])),(r=$e("span",String.fromCharCode(8658))).classList.add("arrow"),i.info.push(r,$e("span",o)),(r=$e("span",String.fromCharCode(8594))).classList.add("arrow"),i.info.push(r),(r=$e("span",l)).appendChild($e("br")),i.info.push(r)),u++}for(u=0;u<nrew;)rew.index[u]<=0&&(l=l.replace(rew["outToIn"+u.toString()],rew["outToInString"+u.toString()])),u++;e!==l&&(a++,"arro"===t?l=e+" "+String.fromCharCode(8594)+" "+l:"dict"===t&&(l+=" ["+e+"]")),i.words.push(l)}}),n&&((o=$e("div")).classList.add("soundChangeEffects"),o.append(...i.info),i.info=[o]),i.info.push($e("div","Categories found: "+cat.index)),i.info.push($e("div","Rewrite rules found: "+nrew.toString())),i.info.push($e("div","Sound changes found: "+nchange.toString())),i.info.push($e("div","Words processed: "+i.words.length.toString())),i.info.push($e("div","Words changed: "+a.toString())),i}
function escapeHTML(e){return $e("p",e).innerHTML}function evolve(){var e,t,n,o,r=[];if(t=$q("input[type=radio][name=outtype]:checked").value,n=$i("reportAppliedRules").checked,o=$i("showDifferences").checked,(e=maybeParseCategories($i("cats").value)).length>0&&r.push(...e),(e=maybeParseSoundChanges($i("change").value)).length>0&&r.push(...e),(e=maybeParseRewriteRules($i("rewrite").value)).length>0&&r.push(...e),erase(),r.length>0){let e=$i("outputText");e.append(...r.shift()),r.forEach(t=>e.append($e("br"),$e("br"),...t))}else{let e=changeTheWords($i("inputLex").value.split(/\r?\n/),t,n),r=$i("outputLex"),i=e.words.slice();if($i("outputText").append(...e.info),i=e.words.slice(),o&&!1!==previousRun){let e=[];for(;i.length;)previousRun&&i[0]===previousRun[0]?e.push(i.shift()):e.push($e("strong",i.shift())),previousRun&&previousRun.shift();i=e}previousRun=e.words.slice(),(r=$i("outputLex")).append(i.shift()),i.forEach(function(e){r.append($e("br"),e)})}}function maybeParseCategories(e){var t,n=[];return e!==previousCat&&(t=e.split(/\r?\n/),ncat=t.length,(cat=new Object).index="",t.every(function(e){var t=e.trim();const o=t.length;if(0===o)ncat--;else{if(o<3||1!==t.indexOf("=")||-1!==t.indexOf("=",2))return n.push([$e("strong","Error:"),SPACE+escapeHTML(t),$e("br"),"Categories must be of the form V=aeiou",$e("br"),"That is, a single letter, an equal ssign, then a list of possible expansions."]),!1;{let e=t.charAt(0);if(cat.hasOwnProperty(e))return n.push([$e("strong","Error:"),"SPACE + You have defined category "+escapeHTML(e)+" more than once."]),!1;cat.index+=t.charAt(0),cat[e]=t.substring(2)}}return!0})&&ncat>0&&(previousCat=e)),n}
function maybeParseSoundChanges(e){var t,n,o,r,i,a=[];return e!==previousChange&&(t=$i("changeSep").value||"/",n=$i("changeBound").value||"#",o=$i("changePos").value||"_",i=standardizePhonoRules(e,t).split(/\r?\n/),nchange=i.length,(change=new Object).eind=[],r=0,i.every(function(e){var i,s,l,u,c,h,d,g,p,f,v,m=e.trim();if(""===m)return nchange--,!0;if([u,c,h,g,...f]=m.split(t),void 0!==g&&(p=(g=g.trim()).indexOf(o)),""===h||void 0===h?(h=o,d=0):d=(h=h.trim()).indexOf(o),void 0===u||void 0===c||""===u&&""===c)return a.push([$e("strong","Error:"),SPACE+m,$e("br"),"Sound changes must be in the form"+SPACE,$e("em","a"+t+"b"+t+"x"+String.fromCharCode(185)+o+"x"+String.fromCharCode(178)),", where"+SPACE,$e("em","a"),SPACE+"is the initial sound,"+SPACE,$e("em","b"),SPACE+"is the sound it changes to, and"+SPACE,"x"+String.fromCharCode(185)+o+"x"+String.fromCharCode(178),SPACE+"is the context of where"+SPACE,$e("em","a"),SPACE+"is, with"+SPACE,$e("em",o),SPACE+"representing the sound being changed."+SPACE,$e("em","a"),SPACE+"or"+SPACE,$e("em","b"),SPACE+"may be blank, but not both."]),!1;if(d<0)return a.push([$e("strong","Error:"),SPACE+m,$e("br"),"Sound changes must be in the form"+SPACE,$e("em","a"+t+"b"+t+"x"+String.fromCharCode(185)+o+"x"+String.fromCharCode(178)),", where"+SPACE,$e("em","a"),SPACE+"is the initial sound,"+SPACE,$e("em","b"),SPACE+"is the sound it changes to, and"+SPACE,$e("em","x"+String.fromCharCode(185)+o+"x"+String.fromCharCode(178)),SPACE+"is the context of where"+SPACE,$e("em","a"),SPACE+"is, with"+SPACE,$e("em",o),SPACE+"representing the sound being changed. (You can omit the context, which will default to"+SPACE,$e("em",o),SPACE+"alone.)"]),!1;if(void 0!==p&&p<0)return a.push([$e("strong","Error:"),SPACE+m,$e("br"),"Sound changes must be in the form"+SPACE,$e("em","a"+t+"b"+t+"x"+String.fromCharCode(185)+o+"x"+String.fromCharCode(178)+t+"y"+String.fromCharCode(185)+o+"y"+String.fromCharCode(178)),", where"+SPACE,$e("em","a"),SPACE+"is the initial sound,"+SPACE,$e("em","b"),SPACE+"is the sound it changes to,"+SPACE,$e("em","x"+String.fromCharCode(185)+o+"x"+String.fromCharCode(178)),SPACE+"is the context of where"+SPACE,$e("em","a"),SPACE+"is, and"+SPACE,$e("em","y"+String.fromCharCode(185)+o+"y"+String.fromCharCode(178)),SPACE+"is a context"+SPACE,$e("em","a"),SPACE+"cannot be, with"+SPACE,$e("em",o),SPACE+"representing the sound being changed. You can omit any of the "+SPACE,$e("em",t),"s and"+SPACE,$e("em",o)+"s but you cannot omit"+SPACE,$e("em",o),SPACE+"from either context."]),!1;if(v=r.toString(),change["rule"+v]=m,"\\\\"===c&&(c=u.reverse()),u=interpretFromAndTo(u),c=interpretFromAndTo(c),!1!==u.cat&&!1!==c.cat){let e,t,n;for(t=u.rule[u.cat],n=c.rule[c.cat];t.length>n.length;)n.push("");u.pre=u.rule.slice(0,u.cat).join(""),u.post=u.rule.slice(u.cat+1).join(""),c.pre=c.rule.slice(0,c.cat).join(""),c.post=c.rule.slice(c.cat+1).join(""),e=[],t.forEach(t=>{e.push(u.pre+t+u.post)}),u=e,e=[],n.forEach(t=>{e.push(c.pre+t+c.post)}),c=e}else!1!==u.cat?u.rule[u.cat]="["+u.rule[u.cat].join("")+"]":!1!==c.cat&&(c.rule[c.cat]="["+c.rule[c.cat].join("")+"]"),u=[u.rule.join("")],c=[c.rule.join("")];return i="("+interpretGivenChanges(h.substring(0,d),n,!0)+")",s="("+interpretGivenChanges(h.substring(d+1),n,!1)+")",l=[],u.forEach(e=>{l.push(new RegExp(i+e+s,"g"))}),change["from"+v]=l.slice(),change["to"+v]=c,void 0!==p?(change.eind.push(!0),i=interpretGivenChanges(g.substring(0,p),n,!0),s=interpretGivenChanges(g.substring(p+1),n,!1),change["exceptionPre"+v]=i,change["exceptionPost"+v]=s):change.eind.push(!1),r++,!0})&&nchange>0?previousChange=e:nchange<=0&&a.push([$e("strong","Error:"),SPACE+"No sound changes provied."])),a}
function maybeParseRewriteRules(e){var t,n,o,r,i,a=[];return e!==previousRew&&(t=e.split(/\r?\n/),nrew=t.length,(rew=new Object).index=[],n=0,o=$i("rewBoth").value||"||",r=$i("rewIn").value||">>",i=$i("rewOut").value||"<<",t.every(function(e){var t,s,l;if(-1!==e.indexOf(o))s=0;else if(-1!==e.indexOf(r))s=1;else{if(-1===e.indexOf(i))return a.push([$e("strong","Error:"),SPACE+e,$e("br"),"Rewrite rules must be in the form"+SPACE,$e("em","a"+o+"b"),", where"+SPACE,$e("em","a"),SPACE+"is the initial pattern and"+SPACE,$e("em","b"),SPACE+"is the pattern it changes to. (",$e("em","a"+r+"b"),SPACE+"and"+SPACE,$e("em","a"+i+"b"),SPACE+"are also acceptable for one-way rules.)"]),!1;s=-1}return l=n.toString(),t=e.split([i,o,r][s+1]),rew["inToOut"+l]=getComplexRegex(t[0],"g"),rew["inToOutString"+l]=t[1],rew["outToIn"+l]=getComplexRegex(t[1],"g"),rew["outToInString"+l]=t[0],rew.index.push(s),n++,!0})&&nrew>0&&(previousRew=e)),a}function getComplexRegex(e,t){for(var n,o,r,i,a=e.split("%%"),s=[];a.length;){for(r=(n=a.shift().split("!%")).shift();n.length;)o=(i=n.shift()).charAt(0),-1!==cat.index.indexOf(o)&&(r+="[^"+cat[o]+"]"),r+=i.substring(1);for(n=r.split("%"),r=n.shift();n.length;)o=(i=n.shift()).charAt(0),-1!==cat.index.indexOf(o)&&(r+="["+cat[o]+"]"),r+=i.substring(1);s.push(r)}return r=s.join("%"),new RegExp(r,t)}function interpretFromAndTo(e,t){var n=new Object,o=!1,r=!1,i=!1,a=0;return n.rule=[],n.cat=!1,e.split("").forEach(function(e){if(o)o=!1,n.rule.push("\\"+e);else{if("\\"===e)return void(o=!0);i?("]"===e&&(i=!1),n.rule.push(e)):"["===e?(i=!0,n.rule.push(e)):r?("}"===e&&(r=!1),n.rule.push(e)):"{"===e?(r=!0,n.rule.push(e)):-1!==cat.index.indexOf(e)?!1!==n.cat?n.rule.push("["+cat[e]+"]"):(n.rule.push(cat[e].split("")),n.cat=a):n.rule.push(e)}a++}),i&&n.rules.push("]"),r&&n.rules.push("}"),n}function interpretGivenChanges(e,t,n){var o=[],r=!1,i=!1,a=!1;return e.split("").forEach(function(e){if(r)r=!1,o.push("\\"+e);else{if("\\"===e)return void(r=!0);a?("]"===e&&(a=!1),o.push(e)):"["===e?(a=!0,o.push(e)):i?("}"===e&&(i=!1),o.push(e)):"{"===e?(i=!0,o.push(e)):e===t?o.push(n?"^":"$"):-1!==cat.index.indexOf(e)?o.push("["+cat[e]+"]"):o.push(e)}}),o.join("")}function showIPA(){erase(),$i("p_chars").appendChild(createIPASymbolsFragment([$e("br"),$e("br")]))}function advancedOptions(){$i("advancedOpen").classList.toggle("closed")}
function erase(){[$i("outputText"),$i("outputLex"),$i("p_chars")].forEach(function(e){for(;e.firstChild;)e.removeChild(e.firstChild)})}function clearBoxes(){$a("#cats,#change,#rewrite").forEach(e=>e.value="")}function prepImport(){$i("importBoxArea").classList.remove("closed"),document.body.style.overflow="hidden"}function removeImportBox(){$i("importTextBox").value="",$i("importBoxArea").classList.add("closed"),document.body.style.overflow="auto"}function doImport(){var e=$i("importTextBox").value,t=/--CATS--\n([\s\S]*)\n--CHANGES--\n([\s\S]*)\n--REWRITE--\n([\s\S]*)\n--FLAGS--\n([^ ]+) ([01]) ([01])\n--ADVANCED--\n([^\n]+)\n([^\n]+)\n([^\n]+)\n([^\n]+)\n([^\n]+)\n([^\n]+)/.exec(e);if(null===t)return doAlert("Incorrect format","","error");$i("cats").value=t[1],$i("change").value=t[2],$i("rewrite").value=t[3],$i(t[4]).checked=!0,$i("showDifferences").checked="0"!==t[5],$i("reportAppliedRules").checked="0"!==t[6],""!==t[7]&&($i("changeSep").value=t[7]),""!==t[8]&&($i("changeBound").value=t[8]),""!==t[9]&&($i("changePos").value=t[9]),""!==t[10]&&($i("rewBoth").value=t[10]),""!==t[11]&&($i("rewIn").value=t[11]),""!==t[12]&&($i("rewOut").value=t[12]),doAlert("Import Successful!","","success"),removeImportBox()}function doExport(){var e="--CATS--\n"+$i("cats").value+"\n--CHANGES--\n"+$i("change").value+"\n--REWRITE--\n"+$i("rewrite").value+"\n--FLAGS--\n"+$q("input[name=outtype]:checked").getAttribute("id")+" "+($i("showDifferences").checked?"1":"0")+" "+($i("reportAppliedRules").checked?"1":"0")+"\n--ADVANCED--\n"+$i("changeSep").value+"\n"+$i("changeBound").value+"\n"+$i("changePos").value+"\n"+$i("rewBoth").value+"\n"+$i("rewIn").value+"\n"+$i("rewOut").value;$i("importTextBox").value=e,prepImport(),doAlert("","Copy this for your own records.<br><br>Hit 'Cancel' when you're done.","info")}function saveCustom(e){if(Customizable){if(CustomInfo&&!0!==e)return doConfirm("Warning!","You already have information saved. Do you want to overwrite it?",function(){saveCustom(!0)},function(){doAlert("Previous information saved.","Nothing overwritten.","success")},"warning","Yes","No");localStorage.setItem("EvolveCats",$i("cats").value),localStorage.setItem("EvolveChanges",$i("change").value),localStorage.setItem("EvolveRewrite",$i("rewrite").value),localStorage.setItem("EvolveShowDiff",$i("showDifferences").checked),localStorage.setItem("EvolveAppliedRules",$i("reportAppliedRules").checked),localStorage.setItem("EvolveOutputType",$q("input[name=outtype]:checked").getAttribute("id")),localStorage.setItem("EvolveSep",$i("changeSep").value),localStorage.setItem("EvolveBound",$i("changeBound").value),localStorage.setItem("EvolvePos",$i("changePos").value),localStorage.setItem("EvolveRwBoth",$i("rewBoth").value),localStorage.setItem("EvolveRwIn",$i("rewIn").value),localStorage.setItem("EvolveRwOut",$i("rewOut").value),CustomInfo=!0,doAlert("Saved to browser.","","success")}else doAlert("","Your browser does not support Local Storage and cannot save your information.","error")}
function clearCustom(e){if(Customizable)if(CustomInfo){if(CustomInfo&&!0!==e)return doConfirm("Warning!","Are you sure you want to delete your saved settings?",function(){clearCustom(!0)},function(){doAlert("Settings kept.","","success")},"warning","Yes","No");["EvolveCats","EvolveChanges","EvolveRewrite","EvolveShowDiff","EvolveAppliedRules","EvolveOutputType","EvolveSep","EvolveBound","EvolvePos","EvolveRwBoth","EvolveRwIn","EvolveRwOut"].forEach(function(e){window.localStorage.removeItem(e)}),window.localStorage.clear(),CustomInfo=!1,doAlert("Cleared from browser.","","success")}else doAlert("You don't have anything saved.","","error");else doAlert("","Your browser does not support Local Storage and cannot save your information.","error")}function loadCustom(){Customizable?CustomInfo?(loadCustomInfo(),doAlert("Saved information has been loaded!","","success")):doAlert("You don't have anything saved.","","error"):doAlert("Sorry!","Your browser does not support Local Storage and cannot save your information.","error")}function loadCustomInfo(){$i("cats").value=localStorage.getItem("EvolveCats"),$i("change").value=localStorage.getItem("EvolveChanges"),$i("rewrite").value=localStorage.getItem("EvolveRewrite"),$i("showDifferences").checked="true"===localStorage.getItem("EvolveShowDiff"),$i("reportAppliedRules").checked="true"===localStorage.getItem("EvolveAppliedRules"),$i(localStorage.getItem("EvolveOutputType")).checked=!0,$i("changeSep").value=localStorage.getItem("EvolveSep"),$i("changeBound").value=localStorage.getItem("EvolveBound"),$i("changePos").value=localStorage.getItem("EvolvePos"),$i("rewBoth").value=localStorage.getItem("EvolveRwBoth"),$i("rewIn").value=localStorage.getItem("EvolveRwIn"),$i("rewOut").value=localStorage.getItem("EvolveRwOut")}function doAlert(e,t,n){"undefined"!=typeof Swal?Swal.fire({type:n,title:e,html:t,customClass:"alertBox",buttonsStyling:!1}):alert((e+" "+t.replace(/<br>/g,"\n").replace(/<[^>]*>/g,"")).trim())}function doConfirm(e,t,n,o,r="question",i="Ok",a="Cancel"){"undefined"!=typeof Swal?Swal.fire({title:e,html:t,type:r,showCancelButton:!0,confirmButtonText:i,cancelButtonText:a,customClass:"alertBox",buttonsStyling:!1}).then(e=>e.value?n():o()):confirm((e+" "+t.replace(/<br>/g,"\n").replace(/<[^>]*>/g,"")).trim())?n():o()}String.prototype.reverse=function(){var e,t="";for(e=this.length-1;e>=0;--e){let n,o,r=1,i=e;for(;i>0&&isCombiningDiacritic(this.charCodeAt(i));)--i,r++;n=this[i],o=this[i-1],i>0&&"\udc00"<=n&&n<="\udfff"&&"\ud800"<=o&&o<="\udbff"&&(--i,r++),t+=this.substr(i,r)}return t},$i("evolveButton").addEventListener("click",evolve),$i("clearBoxesButton").addEventListener("click",clearBoxes),$i("eraseButton").addEventListener("click",erase),$i("showIPAButton").addEventListener("click",showIPA),$i("advancedOptionsButton").addEventListener("click",advancedOptions),$i("saveCustomButton").addEventListener("click",saveCustom),$i("loadCustomButton").addEventListener("click",loadCustom),$i("clearCustomButton").addEventListener("click",clearCustom),$i("prepImportButton").addEventListener("click",prepImport),$i("doExportButton").addEventListener("click",doExport),$i("doImportButton").addEventListener("click",doImport),$i("removeImportBoxButton").addEventListener("click",removeImportBox),"undefined"!=typeof Storage&&(Customizable=!0,null!==localStorage.getItem("EvolveCats")&&(CustomInfo=!0,loadCustomInfo()));
